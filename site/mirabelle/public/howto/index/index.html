<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.80.0" />
    <meta name="description" content="">


    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>The index :: Mirabelle</title>

    
    <link href="/css/nucleus.css?1620506174" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1620506174" rel="stylesheet">
    <link href="/css/hybrid.css?1620506174" rel="stylesheet">
    <link href="/css/featherlight.min.css?1620506174" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1620506174" rel="stylesheet">
    <link href="/css/auto-complete.css?1620506174" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css?1620506174" rel="stylesheet">
    <link href="/css/theme.css?1620506174" rel="stylesheet">
    <link href="/css/tabs.css?1620506174" rel="stylesheet">
    <link href="/css/hugo-theme.css?1620506174" rel="stylesheet">
    
    

    <script src="/js/jquery-3.3.1.min.js?1620506174"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    
  </head>
  <body class="" data-url="/howto/index/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="http://example.org/">
  <h2>Mirabelle</p>
</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1620506174"></script>
<script type="text/javascript" src="/js/auto-complete.js?1620506174"></script>
<script type="text/javascript">
    
        var baseurl = "http:\/\/example.org\/";
    
</script>
<script type="text/javascript" src="/js/search.js?1620506174"></script>

    
  </div>
  
    <section id="homelinks">
      <ul>
        <li>
            <a class="padding" href='/'><i class='fas fa-home'></i> Home</a>
        </li>
      </ul>
    </section>
  

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/howto/" title="How to" class="dd-item
        parent
        
        
        ">
      <a href="/howto/">
          How to
          
      </a>
      
      
        <ul>
          
          
            
          
          

        
          
            
            




 
  
    
    <li data-nav-id="/howto/build/" title="Install or build Mirabelle" class="dd-item
        
        
        
        ">
      <a href="/howto/build/">
          Install or build Mirabelle
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/howto/configuration/" title="Configuration" class="dd-item
        
        
        
        ">
      <a href="/howto/configuration/">
          Configuration
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/howto/stream/" title="Writing streams" class="dd-item
        
        
        
        ">
      <a href="/howto/stream/">
          Writing streams
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/howto/tests/" title="Writing tests" class="dd-item
        
        
        
        ">
      <a href="/howto/tests/">
          Writing tests
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/howto/action-io-ref/" title="I/O and actions reference" class="dd-item
        
        
        
        ">
      <a href="/howto/action-io-ref/">
          I/O and actions reference
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/howto/index/" title="The index" class="dd-item
        parent
        active
        
        ">
      <a href="/howto/index/">
          The index
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/howto/pubsub/" title="Publish Subscribe" class="dd-item
        
        
        
        ">
      <a href="/howto/pubsub/">
          Publish Subscribe
          
      </a>
      
      
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/howto/on-disk-queue/" title="On Disk queue" class="dd-item
        
        
        
        ">
      <a href="/howto/on-disk-queue/">
          On Disk queue
          
      </a>
      
      
    </li>
  
 

            
          
        
        </ul>
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/production/" title="Mirabelle in production" class="dd-item
        
        
        
        ">
      <a href="/production/">
          Mirabelle in production
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/api/" title="HTTP API" class="dd-item
        
        
        
        ">
      <a href="/api/">
          HTTP API
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/extension/" title="Extend Mirabelle" class="dd-item
        
        
        
        ">
      <a href="/extension/">
          Extend Mirabelle
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/integration/" title="Clients and integrations" class="dd-item
        
        
        
        ">
      <a href="/integration/">
          Clients and integrations
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/riemann-diff/" title="Differences with Riemann" class="dd-item
        
        
        
        ">
      <a href="/riemann-diff/">
          Differences with Riemann
          
      </a>
      
      
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/support/" title="Support and contributions" class="dd-item
        
        
        
        ">
      <a href="/support/">
          Support and contributions
          
      </a>
      
      
    </li>
  
 

          
        
    </ul>

    
    

    
    <section id="footer">
      <b><p>Powered by <a href="https://mcorbin.fr">mcorbin</a></p></b>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/'></a> > <a href='/howto/'>How to</a> > The index
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#how-to-push-events-into-the-index">How to push events into the index</a></li>
    <li><a href="#expiration">Expiration</a></li>
    <li><a href="#queries">Queries</a></li>
    <li><a href="#pub-sub">Pub Sub</a></li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              The index
            </h1>
          

        



	<p>The Mirabelle Index is an in memory map which can be used to store events.</p>
<p>One index is instantiated and shared by all streams managed by the Mirabelle configuration file.</p>
<p>Streams instantiated by the API have their own index, per stream.</p>
<h2 id="how-to-push-events-into-the-index">How to push events into the index</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">(<span style="color:#a6e22e">stream</span>
  {<span style="color:#e6db74">:name</span> <span style="color:#e6db74">:bar</span> <span style="color:#e6db74">:default</span> true}
  (<span style="color:#a6e22e">where</span> [<span style="color:#e6db74">:=</span> <span style="color:#e6db74">:service</span> <span style="color:#e6db74">&#34;bar&#34;</span>]
    (index [<span style="color:#e6db74">:host</span> <span style="color:#e6db74">:service</span>])))
</code></pre></div><p>In this example, all events with <code>:service</code> &ldquo;bar&rdquo; will be added to the index. They will be indexed by their <code>:host</code> and <code>:service</code> key.</p>
<p>For example, if these two events <code>{:host &quot;foo&quot; :service &quot;bar&quot; :time 1 :ttl 60}</code> and <code>{:host &quot;mirabelle&quot; :service &quot;bar&quot; :time 1 :ttl 60}</code> arrive in the system, the index would contain two keys:</p>
<p><code>{:host &quot;foo&quot; :service &quot;bar&quot;}</code> -&gt; <code>{:host &quot;foo&quot; :service &quot;bar&quot; :time 1 :ttl 60}</code>
<code>{:host &quot;mirabelle&quot; :service &quot;bar&quot;}</code> -&gt; <code>{:host &quot;mirabelle&quot; :service &quot;bar&quot; :time 1 :ttl 60}</code></p>
<p>If a new event arrives for an already existing key, the old key is overrided.</p>
<p>You can have multiple calls to <code>index</code> in Mirabelle, and index events based on the fields you want.</p>
<h2 id="expiration">Expiration</h2>
<p>In Mirabelle, events have a <code>:time</code> (when the event was generated) and optionally a TTL. The default TTL for events in the index is <code>120</code> (in seconds). You could also add another default TTL using the <code>with</code> stream.</p>
<p>For example, an event with <code>:time</code> 1 and <code>:ttl</code> 120 would be expired at time 122.</p>
<p>Expiration is important. First, a lot of streams which work on windows of events will remove expired events automatically. Indeed, if you use for example <a href="/howto/stream/#coalesce-and-project">coalesce</a>, you don&rsquo;t want to keep forever the latest event for a host which does not emit anymore. When the event is expired, it&rsquo;s removed from the action.</p>
<p>Expiration can also be used to detect services which stopped emitting.</p>
<p>Indeed, if an event stored in the index is expired, it will be reinjected into the stream with <code>:state &quot;expired&quot;</code>. You could then catch it with something like:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">(<span style="color:#a6e22e">expired</span>
  (<span style="color:#a6e22e">error</span>))
</code></pre></div><p>By forwarding expired events into dedicated actions, you can for example trigger alerts based on that.</p>
<p>In order to trigger event expiration from events stored into the index, we should use the <code>reaper</code> action. All streams in Riemann are using the events clocks to trigger side effects, and the reaper action will update the index clock if needed, trigger events expiration, and then reinject the events into streams:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-clojure" data-lang="clojure">(<span style="color:#a6e22e">reaper</span>)
(<span style="color:#a6e22e">reaper</span> <span style="color:#e6db74">:custom-stream</span>)
</code></pre></div><p>By default, events are reinjected into the <code>:default</code> stream. You can also pass a stream name to the reaper action in order to reinject events into another stream.</p>
<p>I recommand you to not call forward all events to the reaper (it will impact performances). Instead, identify a couple of events arriving regularly, and forward them to the reaper in order to update the index clock.</p>
<h2 id="queries">Queries</h2>
<p>You can query the events stored into the index. The query should be a valid <a href="/howto/stream/#filtering-events">where clause</a> in base64. For example <code>[:and [:&gt; :metric 10] [:= :service &quot;bar&quot;]]</code> would be <code>WzphbmQgWzo+IDptZXRyaWMgMTBdIFs6PSA6c2VydmljZSAiYmFyIl1d</code>.</p>
<p>You can send queries using the Mirabelle (or Riemann) TCP clients, or using the <a href="http://localhost:1313/api/#query-the-index">HTTP API</a>.</p>
<h2 id="pub-sub">Pub Sub</h2>
<p>Users can subscribe to the index using Websocket, in order to see in real time which events are indexed. Check the <a href="howto/pubsub/">pubsub documentation</a> for more information.</p>





<footer class=" footline" >
	
</footer>

        
        </div>
        

      </div>

    <div id="navigation">
        
        

        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        

        


	 
	 
		
			<a class="nav nav-prev" href="/howto/action-io-ref/" title="I/O and actions reference"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/howto/pubsub/" title="Publish Subscribe" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>

    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1620506174"></script>
    <script src="/js/perfect-scrollbar.min.js?1620506174"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1620506174"></script>
    <script src="/js/jquery.sticky.js?1620506174"></script>
    <script src="/js/featherlight.min.js?1620506174"></script>
    <script src="/js/highlight.pack.js?1620506174"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1620506174"></script>
    <script src="/js/learn.js?1620506174"></script>
    <script src="/js/hugo-learn.js?1620506174"></script>
    
        
            <script src="/mermaid/mermaid.js?1620506174"></script>
        
        <script>
            mermaid.initialize({ startOnLoad: true });
        </script>
    
    

  </body>
</html>
